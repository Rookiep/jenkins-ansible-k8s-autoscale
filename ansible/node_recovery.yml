---
- name: Kubernetes Node Auto-Recovery (Minikube)
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    # âœ… Use the same kubeconfig Jenkins pipeline uses
    kubeconfig_path: "/tmp/jenkins-kube/config"

  tasks:
    - name: Check Kubernetes cluster status
      shell: kubectl cluster-info --kubeconfig {{ kubeconfig_path }}
      register: cluster_status
      ignore_errors: yes
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Abort if Kubernetes cluster not accessible
      fail:
        msg: |
          âŒ Cluster unreachable.
          ğŸ’¡ Run 'minikube start' manually or verify kubeconfig at {{ kubeconfig_path }}.
      when: cluster_status.rc != 0

    - name: Display successful cluster connection
      debug:
        msg: "âœ… Kubernetes cluster reachable using {{ kubeconfig_path }}."

    - name: Restart Minikube node
      shell: |
        echo "ğŸ”„ Restarting Minikube node..."
        minikube stop
        sleep 5
        minikube start
        echo "âœ… Minikube restarted successfully."
      when: cluster_status.rc == 0