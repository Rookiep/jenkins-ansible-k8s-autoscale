---
- name: Kubernetes Node Auto-Recovery (Minikube or Cluster)
  hosts: localhost
  gather_facts: yes

  vars:
    kubeconfig_path: "/home/partho/.kube/config"

  tasks:
    - name: Check Kubernetes cluster accessibility
      shell: kubectl cluster-info --kubeconfig {{ kubeconfig_path }}
      register: cluster_status
      ignore_errors: yes
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Abort if Kubernetes cluster not accessible
      fail:
        msg: |
          âŒ Kubernetes cluster is not accessible.
          ðŸ’¡ Run 'minikube start' or check your kubeconfig context.
      when: cluster_status.rc != 0

    - name: Display cluster info if accessible
      debug:
        msg: "âœ… Connected to Kubernetes cluster successfully."
      when: cluster_status.rc == 0

    - name: Get list of all nodes
      shell: kubectl get nodes --no-headers -o custom-columns=NAME:.metadata.name,STATUS:.status.conditions[-1].type
      register: node_list
      changed_when: false
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Display node statuses
      debug:
        msg: "{{ node_list.stdout_lines }}"

    - name: Identify NotReady nodes
      set_fact:
        notready_nodes: "{{ node_list.stdout_lines | select('search', 'NotReady') | list }}"

    - name: Show NotReady nodes if any
      debug:
        msg: "âš ï¸ The following nodes are NotReady: {{ notready_nodes }}"
      when: notready_nodes | length > 0

    - name: Restart kubelet service in Minikube for recovery
      shell: |
        minikube ssh "sudo systemctl restart kubelet && sudo systemctl status kubelet --no-pager"
      when: notready_nodes | length > 0
      register: restart_result
      ignore_errors: yes

    - name: Display restart result
      debug:
        msg: "{{ restart_result.stdout }}"
      when: restart_result is defined

    - name: Verify node status post-restart
      shell: kubectl get nodes --no-headers
      register: verify_nodes
      retries: 5
      delay: 10
      until: verify_nodes.stdout.find('NotReady') == -1
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      when: notready_nodes | length > 0

    - name: Final status
      debug:
        msg: "âœ… All nodes are now Ready."
      when: verify_nodes is defined and verify_nodes.stdout.find('NotReady') == -1