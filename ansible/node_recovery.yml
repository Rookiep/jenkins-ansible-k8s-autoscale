---
- name: Comprehensive Minikube Node Recovery
  hosts: localhost
  connection: local
  gather_facts: yes
  
  vars:
    minikube_profile: "minikube"
    
  tasks:
    - name: Get current Minikube status
      command: minikube status -p {{ minikube_profile }} -o json
      register: minikube_status_json
      changed_when: false
      ignore_errors: yes
      
    - name: Display Minikube status
      debug:
        var: minikube_status_json.stdout

    - name: Stop Minikube forcefully
      command: minikube stop -p {{ minikube_profile }}
      register: stop_cmd
      ignore_errors: yes
      
    - name: Kill any remaining Minikube processes
      shell: |
        pkill -f "minikube" || true
        sleep 5
      ignore_errors: yes

    - name: Delete Minikube cluster (if needed)
      command: minikube delete -p {{ minikube_profile }}
      when: minikube_status_json.failed or "'Stopped' in minikube_status_json.stdout"
      ignore_errors: yes

    - name: Start Minikube with fresh configuration
      command: minikube start -p {{ minikube_profile }} --driver=docker
      register: start_cmd
      
    - name: Display start output
      debug:
        var: start_cmd.stdout

    - name: Wait for node to become ready
      shell: |
        timeout 180 bash -c 'until kubectl get nodes -o jsonpath="{{.items[*].status.conditions[?(@.type==\"Ready\")].status}}" | grep -q "True"; do sleep 5; done'
      register: wait_ready
      ignore_errors: yes

    - name: Check final node status
      command: kubectl get nodes
      register: final_nodes
      changed_when: false
      
    - name: Display final node status
      debug:
        var: final_nodes.stdout

    - name: Check all system components
      command: kubectl get pods -n kube-system
      register: system_pods
      changed_when: false
      
    - name: Display system pods
      debug:
        var: system_pods.stdout

    - name: Recovery summary
      debug:
        msg: |
          âœ… Minikube Recovery Summary:
          ðŸ“ Profile: {{ minikube_profile }}
          ðŸ”§ Status: {{ final_nodes.stdout }}
          ðŸ³ Driver: docker
          ðŸ“¦ System Pods: {{ (system_pods.stdout | length) > 0 | ternary('Running', 'Not Running') }}
      when: final_nodes is defined
