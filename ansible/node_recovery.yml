---
- name: "Kubernetes Node Health Check and Auto-Recovery"
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    auto_restart: true           # If false ‚Üí manual confirmation required
    restart_timeout: 300         # Wait up to 5 minutes for node recovery
    simulate_restart: false      # Set to false for real SSH reboot commands

  tasks:

    - name: "Check cluster accessibility"
      command: kubectl cluster-info
      register: cluster_status
      ignore_errors: yes
      changed_when: false

    - name: "Fail early if cluster not accessible"
      when: cluster_status.rc != 0
      fail:
        msg: |
          ‚ùå Kubernetes cluster is not accessible!
          üí° Run `minikube start` or verify your kubeconfig context.

    - name: "Get all node statuses"
      command: kubectl get nodes --no-headers
      register: nodes_output
      changed_when: false

    - name: "Identify unhealthy (NotReady) nodes"
      shell: kubectl get nodes --no-headers | awk '$2 != "Ready" {print $1}'
      register: unhealthy_nodes
      changed_when: false
      ignore_errors: yes

    - name: "Show node health summary"
      debug:
        msg: |
          üè• NODE HEALTH STATUS
          ======================
          Total nodes detected: {{ nodes_output.stdout_lines | length }}
          Unhealthy nodes: {{ unhealthy_nodes.stdout_lines | length }}
          {% if unhealthy_nodes.stdout_lines | length > 0 %}
          ‚ö†Ô∏è Affected nodes: {{ unhealthy_nodes.stdout_lines | join(', ') }}
          {% else %}
          ‚úÖ All nodes are healthy!
          {% endif %}

    - name: "Confirm restart if unhealthy nodes found"
      pause:
        prompt: |
          üö® Unhealthy nodes detected: {{ unhealthy_nodes.stdout_lines | join(', ') }}
          Proceed with draining and restarting these nodes?
          Type 'YES' to confirm:
        echo: yes
      when:
        - unhealthy_nodes.stdout_lines | length > 0
        - not auto_restart

    - name: "Perform node recovery sequence"
      when: unhealthy_nodes.stdout_lines | length > 0
      block:

        - name: "Step 1: Cordon unhealthy nodes"
          command: kubectl cordon {{ item }}
          loop: "{{ unhealthy_nodes.stdout_lines }}"
          ignore_errors: yes

        - name: "Step 2: Drain unhealthy nodes"
          command: kubectl drain {{ item }} --ignore-daemonsets --delete-emptydir-data --force
          loop: "{{ unhealthy_nodes.stdout_lines }}"
          ignore_errors: yes

        - name: "Step 3: Restart unhealthy nodes"
          block:

            - name: "Restart via SSH (production mode)"
              shell: |
                echo "Restarting node {{ item }} via SSH..."
                ssh -o StrictHostKeyChecking=no {{ item }} 'sudo reboot'
              loop: "{{ unhealthy_nodes.stdout_lines }}"
              when: not simulate_restart
              ignore_errors: yes

            - name: "Simulate restart (safe mode)"
              shell: |
                echo "Simulating restart for node {{ item }}..."
                sleep 5
              loop: "{{ unhealthy_nodes.stdout_lines }}"
              when: simulate_restart
              ignore_errors: yes

          rescue:
            - debug:
                msg: "‚ö†Ô∏è Restart step failed ‚Äî continuing to verification."

        - name: "Step 4: Wait for nodes to recover"
          shell: |
            kubectl wait --for=condition=Ready node/{{ item }} --timeout={{ restart_timeout }}s
          loop: "{{ unhealthy_nodes.stdout_lines }}"
          ignore_errors: yes

        - name: "Step 5: Uncordon recovered nodes"
          command: kubectl uncordon {{ item }}
          loop: "{{ unhealthy_nodes.stdout_lines }}"
          ignore_errors: yes

        - name: "Step 6: Verify node readiness"
          command: kubectl get node {{ item }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
          register: node_status
          loop: "{{ unhealthy_nodes.stdout_lines }}"
          ignore_errors: yes

    - name: "Display final recovery summary"
      debug:
        msg: |
          ‚úÖ NODE RECOVERY SUMMARY
          ==========================
          {% if unhealthy_nodes.stdout_lines | length == 0 %}
          üåø All nodes were healthy ‚Äî no action taken.
          {% else %}
          ü©∫ Nodes processed: {{ unhealthy_nodes.stdout_lines | join(', ') }}
          {% for result in node_status.results %}
          üîπ {{ result.item }} ‚Üí {{ result.stdout | default('UNKNOWN') }}
          {% endfor %}
          ‚úÖ Recovery completed.
          {% endif %}