- name: "EMERGENCY Node Recovery - Force Ready State"
  hosts: localhost
  gather_facts: false
  
  tasks:
    - name: "Display current NOTREADY state"
      shell: kubectl get nodes
      register: current_status
      
    - name: "Show problem state"
      debug:
        msg: |
          üî¥ CURRENT STATE - NODE NOTREADY
          ===============================
          {{ current_status.stdout }}

    - name: "Step 1: Check what's actually running in minikube"
      shell: |
        echo "=== Minikube Status ==="
        minikube status
        echo ""
        echo "=== Kubelet Status ==="
        minikube ssh "sudo systemctl status kubelet --no-pager" || echo "Kubelet not running"
        echo ""
        echo "=== Containerd Status ==="
        minikube ssh "sudo systemctl status containerd --no-pager" || echo "Containerd not running"
      register: service_status
      ignore_errors: yes

    - name: "Display service status"
      debug:
        msg: |
          üîß SERVICE STATUS ANALYSIS
          =========================
          {{ service_status.stdout }}

    - name: "Step 2: FORCE RESTART - Stop everything"
      block:
        - name: "Stop minikube completely"
          command: minikube stop
          ignore_errors: yes
          
        - name: "Wait for complete stop"
          pause:
            seconds: 10
            
        - name: "Kill any remaining processes"
          shell: |
            minikube ssh "sudo pkill -f kubelet || true"
            minikube ssh "sudo pkill -f containerd || true"
          ignore_errors: yes

    - name: "Step 3: FORCE RESTART - Start everything fresh"
      block:
        - name: "Start minikube"
          command: minikube start
          ignore_errors: yes
          register: start_result
          
        - name: "Wait for initialization"
          pause:
            seconds: 30
            
        - name: "Force start kubelet if needed"
          shell: |
            minikube ssh "sudo systemctl daemon-reload"
            minikube ssh "sudo systemctl start containerd"
            minikube ssh "sudo systemctl start kubelet"
          ignore_errors: yes
          when: start_result.rc != 0

    - name: "Step 4: Wait for node to become Ready"
      shell: |
        echo "‚è≥ Waiting for node recovery..."
        for i in {1..40}; do
          if kubectl get nodes minikube -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}' 2>/dev/null | grep -q "True"; then
            echo "‚úÖ SUCCESS: Node is now Ready!"
            kubectl get nodes -o wide
            exit 0
          fi
          echo "Still waiting... ($i/40)"
          sleep 3
        done
        echo "‚ùå FAILED: Node still not ready after timeout"
        kubectl get nodes
        exit 1
      register: recovery_wait
      ignore_errors: yes

    - name: "Step 5: Nuclear option if still not working"
      block:
        - name: "Complete cluster reset"
          shell: |
            minikube delete
            minikube start
          ignore_errors: yes
          when: recovery_wait.rc != 0
          
        - name: "Wait after nuclear reset"
          pause:
            seconds: 30

    - name: "Step 6: Final verification"
      shell: |
        echo "=== FINAL STATUS ==="
        kubectl get nodes -o wide
        echo ""
        echo "=== NODE DETAILS ==="
        kubectl describe node minikube | grep -A 10 Conditions
      register: final_status
      ignore_errors: yes

    - name: "Display final results"
      debug:
        msg: |
          üéØ RECOVERY RESULTS
          ==================
          {{ final_status.stdout }}
          
          {% if recovery_wait.rc == 0 %}
          ‚úÖ SUCCESS: Node recovery completed!
          {% else %}
          ‚ùå FAILED: Node still not ready - manual intervention required
          {% endif %}