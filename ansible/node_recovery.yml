- name: "Real Kubernetes Node Recovery"
  hosts: localhost
  gather_facts: false
  
  tasks:
    - name: "Get current node status"
      command: kubectl get nodes
      register: node_status
      
    - name: "Display current status"
      debug:
        msg: |
          ðŸ“Š CURRENT NODE STATUS
          =====================
          {{ node_status.stdout }}

    - name: "Check for NotReady nodes"
      shell: |
        kubectl get nodes --no-headers | grep -v Ready | awk '{print $1}'
      register: notready_nodes
      ignore_errors: yes
      
    - name: "Execute node recovery"
      block:
        - name: "Cordon unhealthy nodes"
          command: "kubectl cordon {{ item }}"
          loop: "{{ notready_nodes.stdout_lines }}"
          
        - name: "Drain nodes"
          command: "kubectl drain {{ item }} --ignore-daemonsets --delete-emptydir-data --force"
          loop: "{{ notready_nodes.stdout_lines }}"
          ignore_errors: yes
          
        - name: "Delete and recreate node"
          command: "kubectl delete node {{ item }}"
          loop: "{{ notready_nodes.stdout_lines }}"
          ignore_errors: yes
          
        - name: "Wait for node to rejoin"
          shell: |
            for i in {1..30}; do
              if kubectl get node {{ item }} &>/dev/null; then
                exit 0
              fi
              sleep 5
            done
            exit 1
          loop: "{{ notready_nodes.stdout_lines }}"
          ignore_errors: yes
          
      when: notready_nodes.stdout_lines | length > 0