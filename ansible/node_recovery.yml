---
- name: Fix Kubernetes Context and Recover Minikube
  hosts: localhost
  connection: local
  
  tasks:
    - name: Check current kubectl context
      command: kubectl config current-context
      register: current_context
      changed_when: false
      ignore_errors: yes
      
    - name: Display current context
      debug:
        var: current_context.stdout

    - name: List all available contexts
      command: kubectl config get-contexts
      register: all_contexts
      changed_when: false
      
    - name: Display all contexts
      debug:
        var: all_contexts.stdout

    - name: Switch to minikube context
      command: kubectl config use-context minikube
      register: switch_context
      
    - name: Verify minikube context
      command: kubectl config current-context
      register: verified_context
      
    - name: Display verified context
      debug:
        var: verified_context.stdout

    - name: Test kubectl connection to minikube
      command: kubectl get nodes
      register: minikube_nodes
      ignore_errors: yes
      
    - name: Display minikube nodes
      debug:
        var: minikube_nodes.stdout

    - name: Check Minikube status
      command: minikube status
      register: minikube_status
      ignore_errors: yes
      
    - name: Display Minikube status
      debug:
        var: minikube_status.stdout

    - name: Restart Minikube if needed
      command: minikube start
      when: minikube_nodes.failed or "'Stopped' in minikube_status.stdout"
      register: minikube_start
      async: 300
      poll: 10
      
    - name: Final verification
      command: kubectl get nodes
      register: final_nodes
      
    - name: Display final status
      debug:
        var: final_nodes.stdout

    - name: Success message
      debug:
        msg: "âœ… Kubernetes context fixed and Minikube is ready!"
      when: final_nodes is defined and not final_nodes.failed