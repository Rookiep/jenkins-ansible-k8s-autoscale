---
- name: "Kubernetes Node Auto-Recovery (Minikube or Cluster)"
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    auto_restart: true           # Set to false to require manual confirmation
    restart_timeout: 300         # Time (in seconds) to wait for node recovery
    simulate_ssh_restart: false  # Set to false for real SSH reboot in clusters

  tasks:
    - name: "Check Kubernetes cluster accessibility"
      command: kubectl cluster-info
      register: cluster_status
      ignore_errors: yes
      changed_when: false

    - name: "Abort if Kubernetes cluster not accessible"
      when: cluster_status.rc != 0
      fail:
        msg: |
          âŒ Kubernetes cluster is not accessible.
          ðŸ’¡ Run 'minikube start' or check your kubeconfig context.

    - name: "Detect cluster type (Minikube or other)"
      shell: kubectl config current-context
      register: kube_context
      changed_when: false

    - name: "Set cluster type variable"
      set_fact:
        is_minikube: "{{ 'minikube' in kube_context.stdout }}"

    - name: "Show detected cluster type"
      debug:
        msg: |
          ðŸ§© Cluster Type Detection
          ========================
          Context: {{ kube_context.stdout }}
          Detected: {{ 'Minikube (Local)' if is_minikube else 'Standard Cluster (Remote)' }}

    - name: "Get all nodes and their status"
      command: kubectl get nodes --no-headers
      register: all_nodes
      changed_when: false

    - name: "Identify unhealthy nodes (NotReady)"
      shell: kubectl get nodes --no-headers | awk '$2 != "Ready" {print $1}'
      register: unhealthy_nodes
      ignore_errors: yes
      changed_when: false

    - name: "Display node health summary"
      debug:
        msg: |
          ðŸ¥ NODE HEALTH SUMMARY
          ======================
          Total nodes: {{ all_nodes.stdout_lines | length }}
          Unhealthy nodes: {{ unhealthy_nodes.stdout_lines | length }}
          {% if unhealthy_nodes.stdout_lines | length > 0 %}
          âš ï¸ Affected nodes: {{ unhealthy_nodes.stdout_lines | join(', ') }}
          {% else %}
          âœ… All nodes are healthy.
          {% endif %}

    - name: "Ask for confirmation if auto_restart disabled"
      pause:
        prompt: |
          âš ï¸ Unhealthy nodes detected: {{ unhealthy_nodes.stdout_lines | join(', ') }}
          Proceed with node restart? (Type 'YES' to confirm)
        echo: yes
      when:
        - unhealthy_nodes.stdout_lines | length > 0
        - not auto_restart

    - name: "Perform node recovery process"
      when: unhealthy_nodes.stdout_lines | length > 0
      block:

        - name: "Step 1: Cordon unhealthy nodes"
          command: kubectl cordon {{ item }}
          loop: "{{ unhealthy_nodes.stdout_lines }}"
          ignore_errors: yes

        - name: "Step 2: Drain unhealthy nodes"
          command: kubectl drain {{ item }} --ignore-daemonsets --delete-emptydir-data --force
          loop: "{{ unhealthy_nodes.stdout_lines }}"
          ignore_errors: yes

        - name: "Step 3: Restart nodes based on environment"
          block:
            - name: "Restart Minikube (Local Environment)"
              shell: |
                echo "ðŸ”„ Restarting Minikube cluster..."
                minikube stop && minikube start
              when: is_minikube
              ignore_errors: yes

            - name: "Restart via SSH (Cluster Environment)"
              shell: |
                echo "ðŸ”„ Restarting remote node {{ item }} via SSH..."
                {% if not simulate_ssh_restart %}
                ssh -o StrictHostKeyChecking=no {{ item }} 'sudo reboot'
                {% else %}
                echo "Simulating SSH reboot for {{ item }}..."
                sleep 5
                {% endif %}
              loop: "{{ unhealthy_nodes.stdout_lines }}"
              when: not is_minikube
              ignore_errors: yes

        - name: "Step 4: Wait for nodes to recover"
          shell: kubectl wait --for=condition=Ready node/{{ item }} --timeout={{ restart_timeout }}s
          loop: "{{ unhealthy_nodes.stdout_lines }}"
          ignore_errors: yes

        - name: "Step 5: Uncordon recovered nodes"
          command: kubectl uncordon {{ item }}
          loop: "{{ unhealthy_nodes.stdout_lines }}"
          ignore_errors: yes

        - name: "Step 6: Verify node readiness"
          command: kubectl get node {{ item }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
          register: recovery_status
          loop: "{{ unhealthy_nodes.stdout_lines }}"
          ignore_errors: yes

    - name: "Display recovery summary"
      debug:
        msg: |
          âœ… NODE RECOVERY SUMMARY
          ==========================
          {% if unhealthy_nodes.stdout_lines | length == 0 %}
          ðŸŒ¿ All nodes healthy â€” no restart required.
          {% else %}
          ðŸ©º Nodes processed: {{ unhealthy_nodes.stdout_lines | join(', ') }}
          {% for node in recovery_status.results %}
          ðŸ”¹ {{ node.item }} â†’ {{ node.stdout | default('UNKNOWN') }}
          {% endfor %}
          âœ… Recovery completed successfully.
          {% endif %}