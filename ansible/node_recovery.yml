---
- name: Kubernetes Node Health Check and Recovery
  hosts: localhost
  gather_facts: false
  vars:
    node_timeout: 60

  tasks:
    - name: Check Minikube status
      command: minikube status
      register: minikube_status
      ignore_errors: yes
      changed_when: false

    - name: Parse node status
      set_fact:
        bad_nodes: []
      when: minikube_status is failed or 'Stopped' in minikube_status.stdout

    - name: Start Minikube if stopped
      command: minikube start
      when: minikube_status is failed or 'Stopped' in minikube_status.stdout

    - name: Check Kubernetes nodes
      command: kubectl get nodes
      register: k8s_nodes
      ignore_errors: yes
      changed_when: false

    - name: Check node conditions
      command: kubectl describe node minikube
      register: node_info
      when: k8s_nodes is succeeded
      ignore_errors: yes

    - name: Restart unhealthy minikube nodes
      block:
        - name: Stop minikube
          command: minikube stop
          ignore_errors: yes

        - name: Start minikube
          command: minikube start
          ignore_errors: yes
      when: 
        - k8s_nodes is failed
        - or
        - "'Ready' not in node_info.stdout"
        - "'NotReady' in node_info.stdout"

    - name: Verify cluster health
      command: kubectl cluster-info
      register: cluster_health
      ignore_errors: yes

    - name: Display recovery status
      debug:
        msg: |
          Minikube Status: {{ minikube_status.stdout if minikube_status is succeeded else 'Failed' }}
          Kubernetes Nodes: {{ k8s_nodes.stdout if k8s_nodes is succeeded else 'Unavailable' }}
          Cluster Health: {{ cluster_health.stdout if cluster_health is succeeded else 'Unhealthy' }}
