---
- name: Kubernetes Node Auto-Recovery (Minikube or Cluster)
  hosts: localhost
  gather_facts: no

  vars:
    kubeconfig_path: "/home/partho/.kube/config"

  tasks:
    - name: Check Kubernetes cluster accessibility
      shell: kubectl cluster-info --kubeconfig {{ kubeconfig_path }}
      register: cluster_status
      ignore_errors: yes
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Abort if Kubernetes cluster not accessible
      fail:
        msg: |
          ‚ùå Kubernetes cluster is not accessible.
          üí° Run 'minikube start' or check your kubeconfig context.
      when: cluster_status.rc != 0

    - name: Display cluster info if accessible
      debug:
        msg: "‚úÖ Connected to Kubernetes cluster successfully."

    - name: Check node readiness
      shell: kubectl get nodes --no-headers | awk '{print $2}'
      register: node_status
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Restart Minikube if node is NotReady
      shell: |
        echo "‚ö†Ô∏è Node not ready, restarting Minikube..."
        minikube stop
        minikube start
      when: "'NotReady' in node_status.stdout"
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Confirm node recovery
      shell: kubectl get nodes
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: nodes

    - debug:
        msg: "üü¢ Node status after recovery:\n{{ nodes.stdout }}"
        