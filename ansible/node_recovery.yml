---
- name: Kubernetes Node Health Check and Restart
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Check cluster accessibility
      command: kubectl cluster-info
      register: cluster_status
      ignore_errors: yes

    - name: Get unhealthy nodes
      shell: |
        kubectl get nodes --no-headers | awk '$2 != "Ready" {print $1}'
      register: unhealthy_nodes
      ignore_errors: yes
      when: cluster_status is succeeded

    - name: Display initial status
      debug:
        msg: |
          Cluster Status: {{ "HEALTHY" if cluster_status is succeeded else "UNREACHABLE" }}
          Unhealthy Nodes: {{ unhealthy_nodes.stdout_lines if unhealthy_nodes is succeeded else "UNKNOWN" }}

    - name: Restart unhealthy nodes
      block:
        - name: Drain and restart each unhealthy node
          debug:
            msg: "Restarting unhealthy node: {{ item }}"
          with_items: "{{ unhealthy_nodes.stdout_lines }}"
          when: unhealthy_nodes.stdout != ""

        - name: Execute node restart procedure
          shell: |
            echo "Draining node: {{ item }}"
            kubectl drain {{ item }} --ignore-daemonsets --delete-emptydir-data --force --grace-period=300 || true
            echo "Node {{ item }} drained. Attempting restart..."
            # Add your node restart command here based on your environment
            # minikube node restart (for minikube)
            # or cloud provider specific commands
            echo "Restart command would execute for: {{ item }}"
          with_items: "{{ unhealthy_nodes.stdout_lines }}"
          ignore_errors: yes
          when: unhealthy_nodes.stdout != ""

        - name: Wait for nodes to recover
          shell: |
            timeout 300 bash -c 'until kubectl get node {{ item }} | grep -q "Ready"; do sleep 10; done'
          with_items: "{{ unhealthy_nodes.stdout_lines }}"
          ignore_errors: yes
          when: unhealthy_nodes.stdout != ""

      when: 
        - cluster_status is succeeded
        - unhealthy_nodes.stdout != ""

    - name: Final status check
      command: kubectl get nodes
      register: final_status
      ignore_errors: yes
      when: cluster_status is succeeded

    - name: Recovery summary
      debug:
        msg: |
          ðŸŽ¯ RECOVERY OPERATION COMPLETE
          =============================
          Action: {{ "NODE RESTART ATTEMPTED" if unhealthy_nodes.stdout != "" else "NO ACTION NEEDED" }}
          Result: {{ "SUCCESS" if final_status is succeeded else "CHECK MANUALLY" }}
          Recommendation: {{ "Monitor node stability" if unhealthy_nodes.stdout != "" else "System stable" }}