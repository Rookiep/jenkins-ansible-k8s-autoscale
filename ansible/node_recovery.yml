---
- name: Automated Kubernetes Node Health Check and Restart
  hosts: localhost
  gather_facts: true

  tasks:
    - name: Check cluster accessibility
      command: kubectl cluster-info
      register: cluster_status
      ignore_errors: yes

    - name: Get unhealthy nodes
      shell: |
        kubectl get nodes --no-headers | awk '$2 != "Ready" {print $1}'
      register: unhealthy_nodes
      ignore_errors: yes
      when: cluster_status is succeeded

    - name: Auto-restart unhealthy nodes
      block:
        - name: Log restart action
          debug:
            msg: "üîÑ AUTO-RESTARTING {{ unhealthy_nodes.stdout_lines | length }} UNHEALTHY NODES"

        - name: Execute restart procedure
          shell: |
            for node in {{ unhealthy_nodes.stdout }}; do
              echo "Restarting node: $node"
              kubectl cordon $node
              kubectl drain $node --ignore-daemonsets --delete-emptydir-data --force
              # Add your actual restart command here
              echo "Node $node restart completed"
              kubectl uncordon $node
            done
          when: unhealthy_nodes.stdout != ""
          ignore_errors: yes

      when: 
        - cluster_status is succeeded
        - unhealthy_nodes.stdout != ""

    - name: Final status
      debug:
        msg: |
          üèÅ AUTOMATED RECOVERY COMPLETE
          =============================
          Time: {{ ansible_date_time.iso8601 }}
          Action: {{ "NODES RESTARTED" if unhealthy_nodes.stdout != "" else "NO ACTION NEEDED" }}
          Status: SUCCESS