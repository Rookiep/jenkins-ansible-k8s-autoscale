---
- name: Kubernetes Node Auto-Recovery (Minikube or Cluster)
  hosts: localhost
  connection: local   # Prevents SSH; uses local execution
  gather_facts: yes

  vars:
  kubeconfig_path: "/home/jenkins/.kube/config"

  tasks:
    - name: Check Kubernetes cluster accessibility
      shell: kubectl cluster-info --kubeconfig {{ kubeconfig_path }}
      register: cluster_status
      ignore_errors: yes
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Abort if Kubernetes cluster not accessible
      fail:
        msg: |
          âŒ Kubernetes cluster is not accessible.
          ğŸ’¡ Run 'minikube start' or check your kubeconfig context.
      when: cluster_status.rc != 0

    - name: Display cluster info if accessible
      debug:
        msg: "âœ… Connected to Kubernetes cluster successfully."

    - name: Restart Kubernetes node (Minikube)
      shell: |
        echo "ğŸ”„ Restarting Minikube node..."
        minikube stop
        minikube start
      when: cluster_status.rc == 0