---
- name: Restart and Recover Minikube Node
  hosts: localhost
  connection: local
  gather_facts: yes
  
  vars:
    minikube_profile: "minikube"
    wait_timeout: 300
    
  tasks:
    - name: Check current Minikube status
      command: minikube status --profile {{ minikube_profile }}
      register: minikube_status
      changed_when: false
      
    - name: Display current Minikube status
      debug:
        var: minikube_status.stdout

    - name: Check Kubernetes node status
      command: kubectl get nodes
      register: k8s_nodes
      changed_when: false
      ignore_errors: yes
      
    - name: Display Kubernetes node status
      debug:
        var: k8s_nodes.stdout

    - name: Stop Minikube cluster
      command: minikube stop --profile {{ minikube_profile }}
      register: stop_result
      when: "'Stopped' not in minikube_status.stdout"
      
    - name: Display stop result
      debug:
        var: stop_result.stdout
      when: stop_result is defined

    - name: Wait for cluster to stop
      pause:
        seconds: 10
      when: stop_result is defined

    - name: Start Minikube cluster
      command: minikube start --profile {{ minikube_profile }}
      register: start_result
      
    - name: Display start result
      debug:
        var: start_result.stdout

    - name: Wait for Kubernetes API to be ready
      wait_for:
        host: "{{ minikube_ip | default('127.0.0.1') }}"
        port: 8443
        timeout: "{{ wait_timeout }}"
      ignore_errors: yes

    - name: Check Minikube status after restart
      command: minikube status --profile {{ minikube_profile }}
      register: final_minikube_status
      changed_when: false
      
    - name: Display final Minikube status
      debug:
        var: final_minikube_status.stdout

    - name: Check Kubernetes nodes after restart
      command: kubectl get nodes
      register: final_k8s_nodes
      changed_when: false
      
    - name: Display final Kubernetes node status
      debug:
        var: final_k8s_nodes.stdout

    - name: Verify node readiness
      command: kubectl get nodes -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}'
      register: node_readiness
      changed_when: false
      
    - name: Display node readiness status
      debug:
        var: node_readiness.stdout

    - name: Check system pods status
      command: kubectl get pods -n kube-system
      register: system_pods
      changed_when: false
      
    - name: Display system pods status
      debug:
        var: system_pods.stdout

    - name: Final recovery status
      debug:
        msg: |
          ğŸ‰ Minikube node recovery completed!
          ğŸ“Š Initial status: {{ minikube_status.stdout }}
          ğŸ“Š Final status: {{ final_minikube_status.stdout }}
          ğŸŒŸ Node readiness: {{ node_readiness.stdout }}
      when: final_minikube_status is defined